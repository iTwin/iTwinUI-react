---
import Global from './GlobalLayout.astro';
import Header from '../components/Header.astro';
import LeftSidebar from '../components/LeftSidebar.astro';

const { content = {} } = Astro.props;
const currentPage = new URL(Astro.request.url).pathname;
---

<Global content={content} currentPage={currentPage}>
  <Header class='header' />
  <aside class='sidebar' aria-label='Main navigation'>
    <LeftSidebar currentPage={currentPage} />
  </aside>
  <div class='content-wrapper'>
    <h1 id='overview'>{content.title}</h1>
    <slot></slot>
  </div>

  <style lang='scss'>
    body {
      display: grid;
      grid-template: 'header header' auto 'sidebar content' 1fr / auto 1fr;

      &.mobile-sidebar-toggle {
        grid-template: 'header' auto 'sidebar' 1fr / 100%;
      }
    }

    .header {
      grid-area: header;
    }

    .sidebar {
      grid-area: sidebar;
      overflow-y: auto;
      overflow-y: overlay;
      border-right: 1px solid var(--color-line-2);

      @media (max-width: 50em) {
        display: none;
      }

      @nest :global(.mobile-sidebar-toggle) & {
        display: block;
      }
    }

    .content-wrapper {
      grid-area: content;
      overflow: auto;
      overflow: overlay;
      scrollbar-gutter: stable;
      display: grid;
      width: 100%;
      align-items: start;
      justify-content: center;
      padding: var(--space-7);
      grid-template: 'h1' auto 'toc' auto 'main' 1fr / min(100%, 65ch);

      @media (min-width: 1300px) {
        column-gap: calc(var(--space-7) * 2);
        grid-template: 'h1 toc' auto 'main toc' 1fr / min(100%, 65ch) auto;
        position: relative;

        > :global(.toc-wrapper) {
          position: sticky;
          top: 0;
        }
      }

      h1 {
        grid-area: h1;
      }

      > :global(.toc-wrapper) {
        grid-area: toc;
      }

      > :global(main) {
        grid-area: main;
        padding: 0.5rem 0;
      }

      @media (prefers-reduced-motion: no-preference) {
        scroll-behavior: smooth;
      }

      /* this is the table-of-contents */
      & :global(aside) {
        & :global(ol) {
          list-style-type: none;
          padding-left: 1rem;
        }

        & :global(nav) {
          /* counteract extra padding from root ol */
          margin-left: -1rem;
        }

        & :global(a) {
          text-decoration: none;
          color: var(--color-subtext);

          &:hover {
            text-decoration: underline;
          }
        }

        & :global(li) {
          padding: 0;
          margin: 0;
        }

        & :global(li[data-active='true'] > a:first-of-type) {
          font-weight: 600;
        }
      }

      /* this is the main page content */
      & :global(:where(main)) {
        width: 100%;
        height: 100%;
        padding: 1rem 0;
        display: grid;
        align-content: start;
        gap: 0.5rem;

        & > :global(:is(h1, h2, h3, h4, strong)) {
          text-decoration: none;

          & > :global(a) {
            color: inherit;
            text-decoration: none;
            position: relative;

            &:is(:hover, :focus) {
              text-decoration: underline;

              &::before {
                content: '\#';
                position: absolute;
                right: 100%;
                margin-left: 0.25rem;
                margin-right: 0.25rem;
              }
            }
          }

          &:global(:not(:first-child)) {
            margin-top: 1rem;
          }
        }

        :global(:where(:not(a, h1, h2, h3, h4):not(.live-example, .live-example *))) {
          color: var(--color-subtext);
          font-size: var(--type-1);
        }
      }
    }
  </style>
</Global>

<script>
  // adds data-active to the headings that are currently in viewport
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const id = entry.target.getAttribute('id');
      if (entry.intersectionRatio > 0) {
        document.querySelector(`nav li a[href='#${id}']`).parentElement.dataset.active = 'true';
      } else {
        document.querySelector(`nav li a[href='#${id}']`).parentElement.dataset.active = 'false';
      }
    });
  });

  document.querySelectorAll(':is(h1,h2,h3,h4)').forEach((section) => {
    observer.observe(section);
  });
</script>
